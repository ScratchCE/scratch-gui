<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google" value="notranslate">
    <title>Scratch Community Edition</title>
	<link rel="icon" href="favicon.png">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    
    <link rel="manifest" href="manifest.webmanifest">
    
	
	<style>
	#scratch-gui:not(.loaded) {
		display: none;
	}
	#scratch-gui > iframe {
		border: none;
	}
	#scratch-gui.fill-screen {
		position: absolute;
		top: 0;
		left: 0;
		width: 100vw;
		height: 100vh;
		overflow: hidden;
	}
	#scratch-gui.fill-screen > iframe {
		width: 100%;
		height: 100%;
	}
	</style>
	
    <link rel="dns-prefetch" href="https://trampoline.turbowarp.org/">
    <link rel="dns-prefetch" href="https://projects.scratch.mit.edu/">
    <link rel="dns-prefetch" href="https://assets.scratch.mit.edu/">
  </head>
  <body>
    <div id="splash" aria-hidden="true">
      <noscript>
        <h1>Enable JavaScript</h1>
      </noscript>
    </div>
	<div id="page">
		Now I can put anything here!<br />
		<input type="text" placeholder="Project name..."></input>
		<button
			onclick="ReduxStore.dispatch({type: 'scratch-gui/mode/SET_PLAYER', isPlayerOnly: false}); setFillScreen(true);"
		>See inside</button> <br />
		<div id="scratch-gui"></div>
		Yay
	</div>
	<script>
      (async function() {
		window.addEventListener("reduxtargetadded", function() {
			window.ReduxTarget.addEventListener(
				"statechanged",
				(e) => {
					console.log(e.detail.action.type, e.detail);
				}
			);
		});
		
		let shouldLoadGui = false;
		
		if (location.hash === "" || location.hash === "#0") {
			shouldLoadGui = true;
		} else {
			try {
				const existRes = await fetch(`localhost:8080/projects/${location.hash.substring(1)}/exists`);
				if (existRes.ok) shouldLoadGui = true;
			} catch(e) {}
		}
		
		if (!shouldLoadGui) {
			console.log("did not load gui");
			return;
		}
		
		const searchParams = new URLSearchParams(location.search.substring(1));
		
		// The global object that stores stuff related to the GUI iframe.
		window.gui = {};
		
		gui.container = document.getElementById("scratch-gui");
		gui.frame = document.createElement("iframe");
		
		gui.frame.src = searchParams.has("editor") ? "editor.html" : "index.html" + location.search + location.hash;
		gui.frame.scrolling = "no";
		
		gui.container.appendChild(gui.frame);
		gui.window = gui.frame.contentWindow;
		
		gui.window.addEventListener("reduxtargetadded", () => {
			window.ReduxTarget = gui.window.ReduxTarget;
			window.ReduxStore = gui.window.ReduxStore;
			const target = ReduxTarget;
			gui.container.classList.add("loaded");

			target.addEventListener("statechanged", (e) => {
				console.log(e.detail.action.type, e.detail);
				const action = e.detail.action;
				
				if (action.type === "tw/custom-stage-size/SET") {
					console.log(gui.frame);
					gui.frame.setAttribute("width", action.width + 2);
					gui.frame.setAttribute("height", action.height + 2 + 44);
				}
				if (
					action.type === "scratch-gui/mode/SET_FULL_SCREEN" ||
					action.type === "scratch-gui/mode/SET_PLAYER"
				) {
					const mode = e.detail.next.scratchGui.mode;
					const shouldFillScreen = !mode.isPlayerOnly || mode.isFullScreen;
					if (action.type === "scratch-gui/mode/SET_PLAYER" && shouldFillScreen) {
						gui.container.classList.add("not-player-only");
					}
					setFillScreen(shouldFillScreen);
				}
			});
		});
		
      })();
	  
	  function setFillScreen(fillScreen) {
		if (fillScreen) {
			gui.container.classList.add("fill-screen");
		} else {
			gui.container.classList.remove("fill-screen");
			gui.container.classList.remove("not-player-only");
		}
	  }
    </script>
  </body>
</html>
